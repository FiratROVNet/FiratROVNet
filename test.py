import numpy as np
import matplotlib.pyplot as plt
from shapely.geometry import Point, LineString, Polygon, MultiPolygon
from shapely.ops import unary_union, nearest_points

# ==========================================
# 1. VERİLER (Sizin verdiğiniz çıktılar)
# ==========================================

# Mevcut Kontur (Hull) Noktaları
hull_array = np.array([[ 185.687     ,  -28.495     ],
       [-143.67596511,  -20.85070176],
       [-143.70855858,  -19.42456839],
       [-143.88627679,  -17.9633055 ],
       [-144.20636805,  -16.52649842],
       [-144.6657497 ,  -15.12798439],
       [-145.25999765,  -13.78123186],
       [-145.98338896,  -12.4992108 ],
       [-146.82895699,  -11.29426777],
       [-147.78855844,  -10.17800703],
       [-148.85295184,   -9.16117877],
       [-150.01188649,   -8.25357563],
       [-151.25420121,   -7.46393829],
       [-152.56793185,   -6.79987142],
       [-153.94042645,   -6.26777033],
       [-155.35846714,   -5.87275944],
       [-156.80839741,   -5.61864294],
       [-163.5428062 ,   -4.77645401],
       [-164.35431492,   -3.88109211],
       [-165.80858486,   -2.56301867],
       [-167.38504588,   -1.39383549],
       [-169.06851581,   -0.38480245],
       [-170.28376371,    0.18996701],
       [-160.538     ,    6.308     ],
       [-147.80346812,    7.16748952],
       [-147.76484341,    6.53233604],
       [-147.53190405,    5.07885324],
       [-147.15762012,    3.65520141],
       [-146.64559619,    2.27509109],
       [-146.00076333,    0.9518135 ],
       [-145.22933163,   -0.30188747],
       [-144.33873041,   -1.47393801],
       [-143.33753663,   -2.55305061],
       [-142.23539233,   -3.52883284],
       [-141.04291179,   -4.39188738],
       [-139.77157922,   -5.13390254],
       [-133.74891654,   -8.26343136],
       [-133.59469498,   -8.69445175],
       [-132.75552962,  -10.46871784],
       [-131.74649658,  -12.15218776],
       [-130.5773134 ,  -13.72864878],
       [-129.25923996,  -15.18291872],
       [-127.80497002,  -16.50099217],
       [-126.22850899,  -17.67017534],
       [-124.54503907,  -18.67920839],
       [-122.77077298,  -19.51837375],
       [-120.92279788,  -20.17958981],
       [-119.01891077,  -20.65648871],
       [-117.07744714,  -20.94447763],
       [-115.11710433,  -21.0407831 ],
       [-113.15676153,  -20.94447763],
       [-111.21529789,  -20.65648871],
       [-109.31141079,  -20.17958981],
       [-107.46343569,  -19.51837375],
       [-105.6891696 ,  -18.67920839],
       [-104.00569967,  -17.67017534],
       [-102.42923865,  -16.50099217],
       [-100.97496871,  -15.18291872],
       [ -99.65689527,  -13.72864878],
       [ -98.48771209,  -12.15218776],
       [ -97.47867905,  -10.46871784],
       [ -96.63951368,   -8.69445175],
       [ -95.97829762,   -6.84647664],
       [ -95.50139872,   -4.94258954],
       [ -95.2134098 ,   -3.00112591],
       [ -95.11710433,   -1.0407831 ],
       [ -95.2134098 ,    0.91955971],
       [ -95.50139872,    2.86102334],
       [ -95.97829762,    4.76491045],
       [ -96.63951368,    6.61288555],
       [ -97.47867905,    8.38715164],
       [ -98.48771209,   10.07062156],
       [ -98.78811932,   10.47567383],
       [ 158.933     ,   27.87      ],
       [ 185.687     ,  -28.495     ]])

# Ada Çevre Noktaları (3D - Z'yi atacagiz)
forbidden_raw = [(-180.0, 223.4889498885529, 0.0), (-158.25552505572355, 217.66253538739525, 0.0), (-142.33746461260475, 201.74447494427645, 0.0), (-136.5110501114471, 180.0, 0.0), (-142.33746461260475, 158.25552505572355, 0.0), (-158.25552505572355, 142.33746461260475, 0.0), (-180.0, 136.5110501114471, 0.0), (-201.74447494427645, 142.33746461260475, 0.0), (-217.66253538739522, 158.25552505572352, 0.0), (-223.4889498885529, 180.0, 0.0), (-217.66253538739525, 201.74447494427645, 0.0), (-201.74447494427648, 217.66253538739522, 0.0), (188.1621407362545, -114.79214523989688, 0.0), (205.39515332990095, -119.4097170475198, 0.0), (218.01059411592445, -132.02515783354332, 0.0), (222.62816592354739, -149.25817042718975, 0.0), (218.01059411592445, -166.4911830208362, 0.0), (205.39515332990095, -179.1066238068597, 0.0), (188.1621407362545, -183.72419561448262, 0.0), (170.92912814260808, -179.1066238068597, 0.0), (158.31368735658458, -166.49118302083622, 0.0), (153.69611554896164, -149.25817042718975, 0.0), (158.31368735658458, -132.02515783354332, 0.0), (170.92912814260808, -119.40971704751982, 0.0), (-149.081993600567, 32.9241061693849, 0.0), (-132.09954896650655, 28.373673844182154, 0.0), (-119.66753665764887, 15.941661535324467, 0.0), (-115.11710433244612, -1.0407830987359696, 0.0), (-119.66753665764887, -18.0232277327964, 0.0), (-132.09954896650655, -30.455240041654097, 0.0), (-149.081993600567, -35.00567236685684, 0.0), (-166.06443823462743, -30.455240041654093, 0.0), (-178.4964505434851, -18.02322773279642, 0.0), (-183.04688286868787, -1.0407830987359779, 0.0), (-178.4964505434851, 15.941661535324467, 0.0), (-166.06443823462743, 28.373673844182143, 0.0), (-70.63844579904946, -85.96164189645984, 0.0), (-52.09139685269176, -90.93130868361689, 0.0), (-38.5140146934911, -104.50869084281754, 0.0), (-33.544347906334046, -123.05573978917525, 0.0), (-38.5140146934911, -141.60278873553295, 0.0), (-52.09139685269176, -155.1801708947336, 0.0), (-70.63844579904946, -160.14983768189066, 0.0), (-89.18549474540717, -155.1801708947336, 0.0), (-102.76287690460782, -141.60278873553298, 0.0), (-107.73254369176487, -123.05573978917525, 0.0), (-102.76287690460782, -104.50869084281754, 0.0), (-89.1854947454072, -90.93130868361689, 0.0), (67.3478288658012, -107.78394043644695, 0.0), (78.19201476301676, -110.68963129017882, 0.0), (86.13050980650044, -118.62812633366251, 0.0), (89.03620066023231, -129.47231223087806, 0.0), (86.13050980650044, -140.3164981280936, 0.0), (78.19201476301676, -148.2549931715773, 0.0), (67.3478288658012, -151.16068402530917, 0.0), (56.50364296858565, -148.2549931715773, 0.0), (48.56514792510198, -140.31649812809363, 0.0), (45.6594570713701, -129.47231223087806, 0.0), (48.565147925101975, -118.62812633366251, 0.0), (56.50364296858564, -110.68963129017884, 0.0)]


# Yasaklı noktaları 2D'ye çevir (x, y)
forbidden_2d = [(p[0], p[1]) for p in forbidden_raw]

# ==========================================
# 2. SİMÜLASYON FONKSİYONU (yeniden_ciz mantığı)
# ==========================================
def simulate_yeniden_ciz(hull_points, forbidden_points, buffer_radius=15.0, channel_width=10.0):
    # 1. Ana Poligonu Oluştur
    # Verilen noktalar zaten sıralı gibi görünüyor, direkt poligon yapıyoruz
    base_shape = Polygon(hull_points)
    
    # Polygon geçerli mi kontrol et
    if not base_shape.is_valid:
        base_shape = base_shape.buffer(0) # Kendini tamir et

    final_shape = base_shape
    
    # 2. Yasaklı Noktaları Çıkar
    for fp in forbidden_points:
        p_obj = Point(fp)
        
        # Nokta şeklin içinde mi?
        if not final_shape.contains(p_obj):
            continue
            
        print(f"⚠️ Yasaklı nokta tespit edildi (İçeride): {fp}")
        
        # A. Yasaklı Bölge (Güvenlik Çemberi)
        forbidden_zone = p_obj.buffer(buffer_radius)
        
        # B. Kanal Açma (En kısa yoldan dışarı tünel)
        exterior_line = final_shape.exterior
        p1, p2 = nearest_points(forbidden_zone, exterior_line)
        
        channel_line = LineString([p_obj, p2])
        channel_poly = channel_line.buffer(channel_width)
        
        # C. Kesme İşlemi
        cut_area = unary_union([forbidden_zone, channel_poly])
        final_shape = final_shape.difference(cut_area)
        
        # D. Parçalanma temizliği (En büyük parçayı tut)
        if isinstance(final_shape, MultiPolygon):
            final_shape = max(final_shape.geoms, key=lambda a: a.area)
    
    return base_shape, final_shape

# ==========================================
# 3. ÇALIŞTIR VE GÖRSELLEŞTİR
# ==========================================

print(f"Hull Noktası Sayısı: {len(hull_array)}")
print(f"Yasaklı Nokta Sayısı: {len(forbidden_2d)}")

# Hesapla
original_poly, new_poly = simulate_yeniden_ciz(hull_array, forbidden_2d)

# Çizim
fig, ax = plt.subplots(figsize=(10, 10))

# 1. Orijinal Hull (Mavi Çizgi)
x, y = original_poly.exterior.xy
ax.plot(x, y, color='blue', linewidth=1, linestyle='--', label='Orijinal Hull')
ax.fill(x, y, color='blue', alpha=0.1)

# 2. Yasaklı Noktalar (Siyah Noktalar)
fx = [p[0] for p in forbidden_2d]
fy = [p[1] for p in forbidden_2d]
ax.scatter(fx, fy, color='black', marker='x', s=50, label='Ada Çevresi (Yasaklı)')

# 3. Yeni Kesilmiş Hull (Kırmızı Çizgi)
if isinstance(new_poly, Polygon):
    nx, ny = new_poly.exterior.xy
    ax.plot(nx, ny, color='red', linewidth=2, label='Yeni Güvenli Hull')
    ax.fill(nx, ny, color='red', alpha=0.1)

ax.set_title("Ada Engelinden Kaçınma Simülasyonu")
ax.set_xlabel("X (Sağ-Sol)")
ax.set_ylabel("Y (İleri-Geri)")
ax.legend()
ax.grid(True)
ax.axis('equal')

plt.show()
